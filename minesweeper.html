<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  </head>
  <body>
    <div style="margin-right:auto;margin-left:auto;margin-bottom:3em;width:700px;">
      <div align="center">
        <h1>ãƒã‚¤ãƒ³ã‚¹ã‚¤ãƒ¼ãƒ‘</h1>
        ä¸€è¾ºã®ã‚µã‚¤ã‚ºã€€<input type="number" id="size" value="5" style="width:40px"/><br>
        çˆ†å¼¾ã®æ•°ã€€ã€€ã€€<input type="number" id="bomb" value="5" style="width:40px"/><br>
        <br>
        <input type="button" id="start" value="ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ"/><br>
        <br>
        <div id="board"></div>
      </div>
      <br>

    </div>

    <script>
      $(function(){
        var size, bomb, bombList, numList, data;
        var board = $("#board");

        $("#start").on('click', function(){
          size = parseInt($("#size").val());
          bomb = parseInt($("#bomb").val());
          // æ•°å€¤ãƒã‚§ãƒƒã‚¯
          console.log(size, bomb);
          switch(true){
            case size*size<bomb:
              alert("çˆ†å¼¾ã®æ•°ã¯ãƒã‚¹ã®æ•°ã‚ˆã‚Šå°‘ãªãæŒ‡å®šã—ã¦ãã ã•ã„");
              retern -1;
            case size<=0 || bomb<0:
              alert("æ­£ã—ã„æ•°ã‚’æŒ‡å®šã—ã¦ãã ã•ã„");
              return -1;
            case size>18:
              alert("ä¸€è¾ºã®ã‚µã‚¤ã‚ºã¯18ä»¥ä¸‹ã§æŒ‡å®šã—ã¦ãã ã•ã„");
              return -1;
          }
          // ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
          $("#board").empty();
          var squareSize = (size>7) ? 480/size : 40;
          for(var i=0; i<size; i++){
            for(var j=0; j<size; j++){
              $('<input type="button" id="c' + i + ':' + j +
                '" class="cell" style="width:' + squareSize +
                'px;height:' + squareSize + 'px;font-size:13pt;margin:0;padding:0;" value=" "/> ')
                .appendTo("#board");
            }
            $('<br>').appendTo("#board");
          }

          // çˆ†å¼¾ã¨ãã®éš£æ¥ã™ã‚‹ãƒã‚¹ã®åº§æ¨™ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
          bombList = [];
          numList = [];
          var directions = [[-1,0],[-1,1],[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1]];
          for(var i=0; i<bomb; i++){
            //çˆ†å¼¾ã®åº§æ¨™ã‚’ä¹±æ•°ã§ç”Ÿæˆ
            var randPlace;
            while(true){
              randPlace = [Math.floor(Math.random()*size), Math.floor(Math.random()*size)];
              if(!bombList.some((x) => x[0]===randPlace[0] && x[1]===randPlace[1])){
                bombList.push(randPlace);
                break;
              }
            }
            //çˆ†å¼¾ã®ãƒã‚¹ã«éš£æ¥ã™ã‚‹8ãƒã‚¹ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
            console.log("r", randPlace, directions.length);
            for(var j=0; j<directions.length; j++){

              if(0<=randPlace[0]+directions[j][0] && randPlace[0]+directions[j][0]<size &&
                 0<=randPlace[1]+directions[j][1] && randPlace[1]+directions[j][1]<size){
                numList.push([randPlace[0]+directions[j][0], randPlace[1]+directions[j][1]]);
                console.log(123);
              }
            }
          }
          console.log("bomb", bombList);

          // ãƒã‚¹å…¨ä½“ã®ãƒ‡ãƒ¼ã‚¿ã®äºŒæ¬¡å…ƒé…åˆ—ã‚’ç”Ÿæˆ
          data = new Array(size);
          console.log(111,data);
          for(var i=0; i<size; i++){
            data[i] = (new Array(size)).fill(0);
          }

          // çˆ†å¼¾ã®ãƒã‚¹ã«éš£æ¥ã™ã‚‹ãƒã‚¹ã«ï¼‘ã‚’åŠ ç®—
          for(var i=0; i<numList.length; i++){
            data[numList[i][0]][numList[i][1]]++;
          }

          // çˆ†å¼¾ã®ãƒã‚¹ã«çˆ†å¼¾ã‚’ã‚»ãƒƒãƒˆ
          for(var i=0; i<bomb; i++){
            data[bombList[i][0]][bombList[i][1]] = "ğŸ’£";
          }
          //console.log(data);
        });

        $("#board").on("click", ".cell", function(e){
          var id = $(e.target).attr("id");
          var y = parseInt(id.slice(1, id.indexOf(":")));
          var x = parseInt(id.slice(id.indexOf(":")+1));
          // HTMLã«è¡¨ç¤º
          var clearFlag = false;
          if(data[y][x] === "ğŸ’£"){
            for(var i=0; i<bomb; i++){
              $("#board").find(".cell").eq(bombList[i][0]*size+bombList[i][1]).val("ğŸ’£");
              //console.log($("#board").find(".cell").eq(bombList[i][0]*size+bombList[i][1]).attr("id"));
            }
            console.log("yx", y, x, "out");
          }else{
            $(e.target).val(data[y][x]);
            console.log("yx", y, x, "safe");
            var cnt = 0;
            var safeFlag = true;
            $.each($("#board").find(".cell"), function(index, value) {
              if(value.value === ' ') cnt++;
              if(value.value === 'ğŸ’£') safeFlag = false;
            });
            if(bomb===cnt && safeFlag){
              console.log("game clear");
              clearFlag = true;
            }
          }
          if(clearFlag) alert("ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢");
        });
      });
    </script>
  </body>
</html>
