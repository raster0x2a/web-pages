<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒƒãƒ—æŠ•ç¨¿SNS</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        /* Leafletã®ã‚³ãƒ³ãƒ†ãƒŠã®é«˜ã•ã‚’ç¢ºä¿ */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤º */
        }
        #map {
            height: 100%;
            width: 100%;
        }
        /* Leafletãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®è§’ã‚’ä¸¸ãã™ã‚‹ */
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ å¹ãå‡ºã—ï¼ˆãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .custom-tooltip {
            background-color: white;
            border: 2px solid #3b82f6; /* ãƒãƒ¼ã‚«ãƒ¼ã®è‰²ã¨åˆã‚ã›ã‚‹ */
            border-radius: 0.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            font-weight: 500;
            color: #1f2937;
            padding: 8px 12px;
            white-space: pre-wrap; /* ãƒ†ã‚­ã‚¹ãƒˆã®æ”¹è¡Œã‚’è¨±å¯ */
            word-wrap: break-word; /* é•·ã„å˜èªã‚’æŠ˜ã‚Šè¿”ã™ */
            min-width: 150px; /* æœ€å°å¹…ã‚’è¨­å®š */
            max-width: 300px; /* æœ€å¤§å¹…ã‚’èª¿æ•´ */
        }
        /* å¹ãå‡ºã—ã®ã—ã£ã½ã®è‰²ã‚’æ ç·šã®è‰²ã¨åˆã‚ã›ã‚‹ */
        .leaflet-tooltip-top.custom-tooltip::before {
            border-top-color: #3b82f6;
        }
        .leaflet-tooltip-bottom.custom-tooltip::before {
            border-bottom-color: #3b82f6;
        }
        .leaflet-tooltip-right.custom-tooltip::before {
            border-right-color: #3b82f6;
        }
        .leaflet-tooltip-left.custom-tooltip::before {
            border-left-color: #3b82f6;
        }
    </style>
</head>
<body class="font-sans">

    <!-- åœ°å›³ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="map" class="z-0"></div>

    <!-- æŠ•ç¨¿ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« (åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º) -->
    <div id="postModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[1000] p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿</h2>
            <textarea id="postText" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" rows="4" placeholder="ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancelPost" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="submitPost" class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors shadow">æŠ•ç¨¿</button>
            </div>
        </div>
    </div>
    
    <!-- ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div class="fixed top-4 left-1/2 -translate-x-1/2 bg-white bg-opacity-90 p-3 rounded-full shadow-lg z-[500] pointer-events-none w-11/12 max-w-md">
        <p class="text-gray-800 text-center text-sm md:text-base font-medium">ğŸ“ ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æŠ•ç¨¿ã€‚ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤ã§ãã¾ã™</p>
    </div>


    <script>
        // --- DOMè¦ç´ ã®å–å¾— ---
        const mapElement = document.getElementById('map');
        const postModal = document.getElementById('postModal');
        const modalContent = document.getElementById('modal-content');
        const postText = document.getElementById('postText');
        const cancelPostBtn = document.getElementById('cancelPost');
        const submitPostBtn = document.getElementById('submitPost');

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let tempLatLng = null; // ä¸€æ™‚çš„ã«ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã‚’ä¿æŒ
        let posts = []; // æŠ•ç¨¿ã‚’ç®¡ç†ã™ã‚‹é…åˆ—
        const markers = {}; // ãƒãƒ¼ã‚«ãƒ¼ã‚’IDã§ç®¡ç†ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

        // --- åœ°å›³ã®åˆæœŸåŒ– ---
        const map = L.map(mapElement, {
            zoomControl: false // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’éè¡¨ç¤º
        }).setView([35.6895, 139.6917], 13); // åˆæœŸä½ç½®ã‚’æ±äº¬ã«è¨­å®š
        L.control.zoom({ position: 'topright' }).addTo(map); // ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å³ä¸Šã«é…ç½®

        // OpenStreetMapã®ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- é–¢æ•°å®šç¾© ---

        /**
         * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•°
         */
        const openModal = (latlng) => {
            tempLatLng = latlng;
            postText.value = '';
            postModal.classList.remove('hidden');
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã®é…å»¶å®Ÿè¡Œ
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
            postText.focus();
        };

        /**
         * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°
         */
        const closeModal = () => {
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                postModal.classList.add('hidden');
                tempLatLng = null;
            }, 300); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã¨åˆã‚ã›ã‚‹
        };

        /**
         * HTMLæ–‡å­—åˆ—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹é–¢æ•° (XSSå¯¾ç­–)
         * @param {string} str - ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹æ–‡å­—åˆ—
         * @returns {string} - ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸå®‰å…¨ãªHTMLæ–‡å­—åˆ—
         */
        const escapeHTML = (str) => {
            const p = document.createElement('p');
            p.textContent = str;
            return p.innerHTML.replace(/\n/g, '<br>');
        };

        /**
         * æŠ•ç¨¿ã‚’LocalStorageã«ä¿å­˜ã™ã‚‹
         */
        const savePosts = () => {
            localStorage.setItem('map-sns-posts', JSON.stringify(posts));
        };

        /**
         * ãƒãƒƒãƒ—ã‹ã‚‰ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤ã—ã€æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹
         * @param {string} id - å‰Šé™¤ã™ã‚‹æŠ•ç¨¿ã®ID
         */
        const deletePost = (id) => {
            // é…åˆ—ã‹ã‚‰æŠ•ç¨¿ã‚’é™¤å¤–
            posts = posts.filter(post => post.id !== id);
            savePosts();

            // ãƒãƒƒãƒ—ã‹ã‚‰ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
            if (markers[id]) {
                map.removeLayer(markers[id]);
                delete markers[id];
            }
        };
        
        /**
         * ãƒãƒƒãƒ—ã«ãƒãƒ¼ã‚«ãƒ¼ã¨å¹ãå‡ºã—ã‚’è¿½åŠ ã™ã‚‹
         * @param {object} post - æŠ•ç¨¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ {id, text, lat, lng}
         */
        const addMarker = (post) => {
            // ã‚·ãƒ³ãƒ—ãƒ«ãªå††å½¢ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
            const marker = L.circleMarker([post.lat, post.lng], {
                radius: 8,
                fillColor: "#3b82f6",
                color: "#ffffff",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.9
            }).addTo(map);
            
            // æŠ•ç¨¿å†…å®¹ã‚’å¸¸æ™‚è¡¨ç¤ºã®å¹ãå‡ºã—ï¼ˆãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼‰ã¨ã—ã¦ãƒã‚¤ãƒ³ãƒ‰
            marker.bindTooltip(escapeHTML(post.text), {
                permanent: true,      // å¸¸ã«è¡¨ç¤º
                direction: 'right',   // ãƒãƒ¼ã‚«ãƒ¼ã®å³ã«è¡¨ç¤º
                offset: [10, 0],      // è¡¨ç¤ºä½ç½®ã‚’å¾®èª¿æ•´
                className: 'custom-tooltip' // ã‚«ã‚¹ã‚¿ãƒ CSSã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
            });
            
            // å‰Šé™¤ãƒœã‚¿ãƒ³ç”¨ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
            const popupContent = `
                <div class="p-2 text-center">
                    <button class="delete-post-btn text-red-500 hover:text-red-700 font-semibold" data-id="${post.id}">
                        ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤
                    </button>
                </div>
            `;
            marker.bindPopup(popupContent);
            
            // ãƒãƒ¼ã‚«ãƒ¼ã‚’ç®¡ç†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ 
            markers[post.id] = marker;

            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã‹ã‚ŒãŸéš›ã«ã€å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            marker.on('popupopen', () => {
                const deleteBtn = document.querySelector(`.delete-post-btn[data-id='${post.id}']`);
                if (deleteBtn) {
                    deleteBtn.onclick = () => {
                        map.closePopup(); // å‰Šé™¤å‰ã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
                        deletePost(post.id);
                    };
                }
            });
        };
        
        /**
         * LocalStorageã‹ã‚‰æŠ•ç¨¿ã‚’èª­ã¿è¾¼ã‚“ã§ãƒãƒƒãƒ—ã«è¡¨ç¤ºã™ã‚‹
         */
        const loadPosts = () => {
            const savedPosts = localStorage.getItem('map-sns-posts');
            if (savedPosts) {
                posts = JSON.parse(savedPosts);
                posts.forEach(addMarker);
            }
        };


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---

        // ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ã§æŠ•ç¨¿ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        map.on('click', (e) => openModal(e.latlng));

        // æŠ•ç¨¿ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
        cancelPostBtn.addEventListener('click', closeModal);

        // æŠ•ç¨¿å®Ÿè¡Œãƒœã‚¿ãƒ³
        submitPostBtn.addEventListener('click', () => {
            const text = postText.value.trim();
            if (!text) {
                alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            if (!tempLatLng) {
                alert('å ´æ‰€ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            const newPost = {
                id: Date.now().toString(), // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’ç”Ÿæˆ
                text: text,
                lat: tempLatLng.lat,
                lng: tempLatLng.lng
            };

            posts.push(newPost);
            savePosts();
            addMarker(newPost);
            closeModal();
        });

        // --- åˆæœŸåŒ–å‡¦ç† ---
        // DOMã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸã‚‰ã€ä¿å­˜ã•ã‚ŒãŸæŠ•ç¨¿ã‚’èª­ã¿è¾¼ã‚€
        document.addEventListener('DOMContentLoaded', loadPosts);

    </script>
</body>
</html>

